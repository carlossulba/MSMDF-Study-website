<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Collection Session - Mobile Device Privacy Defenses Study</title>
    <link rel="icon" href="media/device fingerprint.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <a href="https://www.tu-berlin.de/" target="_blank">
                <img src="media/TU-Berlin-Logo.svg" alt="TU Berlin Logo" class="h-12">
            </a>
            <a href="https://www.mlsec.org/" target="_blank">
                <img src="media/mlsec-logo.jpg" alt="MLSec Logo" class="h-12">
            </a>
            <a href="index.html" target="">
                <img src="media/device fingerprint.png" alt="Experiment Logo" class="h-12">
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex flex-col items-center relative">
        <h1 class="text-3xl sm:text-4xl lg:text-4xl font-bold mb-6 text-center">Data Collection Session</h1>

        <div id="step0" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Instructions</h2>
                <div id="bar0" style="width: 10px; height: 10px; background-color: #3498db; margin: 0 auto; transition: width 0.2s ease-in-out;"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:00</div>
            </div>
            <p class="mb-4 text-justify">
                In this site, we will collect raw motion sensor data from your phone. Please follow a series of 5 steps to complete the process.
            </p>
            <p class="mb-4 text-justify">
                To help you stay on track, weâ€™ve set up a clock and a movement bar. These are just guides, you may complete the steps in less time.
            </p>
            <p class="mb-4 text-justify">
                If you encounter any issues, you can reset the session and start over again.
            </p>
            <p class="mb-4 text-justify">
                <p class="font-bold text-md">Before proceeding, please ensure:</p>
                <ul class="list-disc list-inside mt-2 mb-4 text-justify text-sm sm:text-base">
                    <li> Your phone's volume is at maximum.</li>
                    <li> You have enough space to walk 10 steps in a straight line.</li>
                    <li> You are in a quiet place.</li>
                    <li> You are standing and ready for data collection.</li>
                </ul>
                When you are ready, double-tap the button below to begin.
            </p>

            <button id="readyButton" onclick="handleReadyTap(this)" class="mt-5 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Ready (Tap Twice)
            </button>
        </div>
    
        <div id="step1" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 1: Start Recording</h2>
                <div id="bar1" style="width: 10px; height: 10px; background-color: #3498db; margin: 0 auto; transition: width 0.2s ease-in-out;"></div>
                <div id="timer1" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:20</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Open the Sensor Logger app and start the recording. Please confirm that the study is active.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4 p-4 bg-black rounded-lg" style="max-width: 400px; border: 1px solid black; border-radius: 30px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);">
                    <img src="media/step1.gif" alt="Step 1 Instruction GIF" class="rounded-lg" style="height: 450px; width: 100%;">
                </div>
            </div>
            <button onclick="handleTap(this, 1)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 1 (Tap Twice)
            </button>
        </div>
        
        <div id="step2" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 2: On Hand</h2>
                <div id="bar2" style="width: 10px; height: 10px; background-color: #3498db; margin: 0 auto; transition: width 0.2s ease-in-out;"></div>
                <div id="timer2" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:20
                </div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Hold your phone still in your hand for 10 seconds, as if you were reading a text. 
                Keep your arm relaxed, and avoid any movement.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step2.png" alt="Step 2 Instruction" class="w-full rounded" style="height: 450px;">
                </div>
            </div>
            <button onclick="handleTap(this, 2)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 2 (Tap Twice)
            </button>
        </div>
        
        <div id="step3" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 3: On Table</h2>
                <div id="bar3" style="width: 10px; height: 10px; background-color: #3498db; margin: 0 auto; transition: width 0.2s ease-in-out;"></div>
                <div id="timer3" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:20
                </div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Place your phone on a flat surface, such as a table, and leave it untouched for 10 seconds. 
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step3.png" alt="Step 2 Instruction" class="w-full rounded" style="height: 450px;">
                </div>
            </div>
            <button onclick="handleTap(this, 3)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 3 (Tap Twice)
            </button>
        </div>
        
        <div id="step4" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 4: Repeat</h2>
                <div id="bar4" style="width: 10px; height: 10px; background-color: #3498db; margin: 0 auto; transition: width 0.2s ease-in-out;"></div>
                <div id="timer4" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:30
                </div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Repeat Steps 2 and 3. This time, the website will play inaudible audio in the background. 
                Hold your phone still in your hand for 10 seconds, then place it on a flat surface for another 10 seconds.
            </p>
            <div class="flex justify-center items-center">
                <div class="flex justify-center items-center">
                    <div class="mt-3 mb-4">
                        <img src="media/step4.png" alt="Step 2 Instruction" class="w-full rounded" style="height: 450px;">
                    </div>
                </div>
            </div>
            <button onclick="handleTap(this, 4)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 4 (Tap Twice)
            </button>
        </div>
        
        <div id="step5" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 5: Walk</h2>
                <div id="timer5" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:40
                </div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Walk 10 steps in a straight line, change direction, and walk another 10 steps. 
                Hold your phone in your hand and move your arms naturally. 
                Pause briefly before changing direction.
            </p>
            <div class="flex justify-center items-center">
                <div class="flex justify-center items-center">
                    <div class="mt-3 mb-4">
                        <img src="media/step5.png" alt="Step 2 Instruction" class="w-full rounded" style="height: 450px;">
                    </div>
                </div>
            </div>
            <button onclick="handleTap(this, 5)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 5 (Tap Twice)
            </button>
        </div>
        
    
        <div id="step6" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl hidden">
            <h2 class="text-2xl font-bold mb-4 text-center">Finish Recording</h2>
            <p class="mb-4 text-justify">
                Congratulations! You have successfully completed all steps. 
                Please return to the Sensor Logger app and tap the 'Stop Recording' button to finish the session.
                Remember to <strong>send your recordings</strong>.
            </p>
            <button onclick="finishStudy()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-full">
                Confirm Recording Stopped
            </button>
        </div>
        
        <div class="flex justify-center w-full max-w-3xl mb-1">
            <button id="resetButton" onclick="showModal()" class="bg-[#486585] hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" style="background-color: #e4313e;">
                Reset Data Collection Session
            </button>
        </div>

        <div id="importantNote" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-center">Important Note</h2>
            <p class="text-justify">
                Please do not delete your browser cookies for the duration of the study. This is crucial for the experiment to function properly and for us to differentiate your device from others.
            </p>
        </div>
    </main>

    <div id="confirmationModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
            <div class="bg-red-600 text-white text-lg font-bold p-4 text-center">
                Stop Data Recording!
            </div>
            <div class="p-6">
                <p class="text-center text-gray-700 mb-4">
                    Please stop the data recording in the Sensor Logger app before resetting the session.
                    This is crucial to prevent data loss.
                </p>
                <div class="flex justify-center space-x-4">
                    <button onclick="proceedReset()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        I Have Stopped Recording
                    </button>
                    <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-4">
        <div class="container mx-auto px-4 flex justify-center items-center space-x-4">
            <p>c.sulbaranfandino@campus.tu-berlin.de</p>
        </div>
    </footer>
    
    <script>
        function showModal() {
            document.getElementById('confirmationModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }

        function proceedReset() {
            window.location.href = "not-first-time-page.html";
        }

        function finishStudy() {
        alert("Thank you for participating in our study! You will now be redirected to the home page.");
        window.location.href = "index.html";
        }

        function playVideosAfterDelay() {
            const videos = document.querySelectorAll('video');
            videos.forEach((video, index) => {
                setTimeout(() => {
                    video.play();
                }, 5000);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            playVideosAfterDelay();
        });

        function startTimer(duration, display) {
            var timer = duration, seconds;
            var interval = setInterval(function () {
                seconds = parseInt(timer % 60, 10);
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = "00:" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    timer = 0;
                }
            }, 1000);
        }

        let tapCount = 0;

        function handleReadyTap(button) {
            tapCount++;
            if (tapCount === 2) {
                document.querySelector('header').classList.add('hidden');
                showStep1();
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 500);
        }
        function showStep1() {
            document.getElementById('step0').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');

            setTimeout(() => {
                startTimer(20, document.querySelector('#timer1'));
            }, 2000);
        }

        let audioContext;
        let oscillator;

        function playInaudibleSound() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioContext.createOscillator();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(20000, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
        }

        function stopInaudibleSound() {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        function handleTap(button, step) {
            tapCount++;
            if (tapCount === 2) {
                showNextStep(step);
                tapCount = 0;

                const durations = [20, 20, 20, 30, 40];
                const nextStepTimer = document.querySelector(`#timer${step + 1}`);
                if (nextStepTimer) {
                    startTimer(durations[step], nextStepTimer);
                }

                if (step === 3) {
                    playInaudibleSound();
                } else if (step === 4) {
                    stopInaudibleSound();
                }

                if (step === 5) {
                    document.querySelector('header').classList.remove('hidden');
                    const resetButton = document.querySelector('#resetButton');
                    if (resetButton) {
                        resetButton.style.display = 'none';
                    }
                    const importantNote = document.querySelector('#importantNote');
                    if (importantNote) {
                        importantNote.style.display = 'block';
                    }
                }
            }
            setTimeout(() => tapCount = 0, 500);
        }


        function showNextStep(currentStep) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${currentStep + 1}`).classList.remove('hidden');
        }

        function startTimer(duration, display) {
            let timer = duration, seconds;
            let interval = setInterval(function () {
                seconds = parseInt(timer % 60, 10);
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = "00:" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    timer = 0;
                }
            }, 1000);
        }

        const baseWidth = 10;
        function handleMotion(event) {
            const acceleration = event.acceleration; // This is without gravity
            if (!acceleration.x && !acceleration.y && !acceleration.z) {
                return; // If no acceleration data, do nothing
            }

            const magnitude = Math.sqrt(
                acceleration.x ** 2 + 
                acceleration.y ** 2 + 
                acceleration.z ** 2
            );
            
            const newWidth = baseWidth + magnitude * 130;
            const clampedWidth = Math.min(Math.max(newWidth, 10), 50);

            // Update each bar
            document.querySelectorAll('[id^="bar"]').forEach(bar => {
                bar.style.width = `${clampedWidth}px`;

                // Change the color of the bar based on the magnitude
                if (magnitude < 0.4) {
                    bar.style.backgroundColor = 'green';
                } else if (magnitude < 1) {
                    bar.style.backgroundColor = 'yellow';
                } else {
                    bar.style.backgroundColor = 'red';
                }
            });
        }

        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', handleMotion, true);
        }
    </script>
</body>
</html>