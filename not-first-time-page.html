<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Collection Session - Mobile Device Privacy Defenses Study</title>
    <link rel="icon" href="media/device fingerprint.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .explanation-card, .execution-card {
            min-height: 650px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .movement-bar {
            width: 60px;
            height: 20px;
            background-color: #3498db;
            margin: 0 auto;
            transition: width 0.2s ease-in-out;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .uniform-image {
            height: 320px;
            object-fit: cover;
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <a href="https://www.tu-berlin.de/" target="_blank">
                <img src="media/TU-Berlin-Logo.svg" alt="TU Berlin Logo" class="h-12">
            </a>
            <a href="https://www.mlsec.org/" target="_blank">
                <img src="media/mlsec-logo.jpg" alt="MLSec Logo" class="h-12">
            </a>
            <a href="index.html" target="">
                <img src="media/device fingerprint.png" alt="Experiment Logo" class="h-12">
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex flex-col items-center relative">
        <h1 class="text-3xl sm:text-4xl lg:text-4xl font-bold mb-6 text-center">Data Collection Session</h1>

        <!-- Step 0: Initial Instructions -->
        <div id="step0" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Instructions</h2>
                <div id="bar0" class="movement-bar"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:00</div>
            </div>
            <p class="mb-4 text-justify">
                In this site, we will guide you through each data collection session.
                Each session is divided in a few steps.
                For each step, we first explain the task, and then give you around 12 seconds to complete it. 
                We have set up a clock and a movement bar to help you keep track of time and motion intensity.
            </p>
            <p class="mb-4 text-justify">
                If you encounter any issues, you can reset the session and start over again.
            </p>
            <p class="mb-4 text-justify">
                <p class="font-bold text-md">Before proceeding, please ensure:</p>
                <ul class="list-disc list-inside mt-2 mb-4 text-justify text-sm sm:text-base">
                    <li> Your phone's volume is at maximum.</li>
                    <li> You have enough space to walk 10 steps in a straight line.</li>
                    <li> You are standing and ready for data collection.</li>
                    <li> There is not too much noise in the background.</li>
                    <li> You are not wearing headphones</li>
                </ul>
                When you are ready, double-tap the button below to begin.
            </p>

            <button id="readyButton" onclick="handleReadyTap(this)" class="mt-5 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Ready (Tap Twice)
            </button>
        </div>
        
        <!-- Step 1: Start Recording -->
        <div id="step1-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Start Recording</h2>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:15</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Open the Sensor Logger app, and start the recording.
                Then return to this page. 
                Please tap the button below twice when you are ready to do it.
                You will have 15 seconds to do it.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4 p-4 bg-black rounded-lg" style="max-width: 400px; border: 1px solid black; border-radius: 30px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);">
                    <img src="media/step1.gif" alt="Step 1 Instruction GIF" class="rounded-lg uniform-image"">
                </div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                <strong>Note:</strong> After 5 recordings, the app will notify you that you have reached the maximum number of recordings allowed. 
                Feel free to delete all previous recordings.
            </p>            
            <button id="startStep1" onclick="handleTap(this, '1')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start (Tap Twice)
            </button>
        </div>

        <div id="step1-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Start Recording</h2>
                <div id="timer1" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:15</div>
            </div>
            <button id="confirmStep1" onclick="handleTap(this, '1')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Recording Started (Tap Twice)
            </button>
        </div>
        
        <!-- Step 2: On Hand -->
        <div id="step2-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl mb-4 font-bold">Step 1: On Hand</h2>
                <div id="bar0" class="movement-bar"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:12</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Stand up and hold your phone still in your hand for 10 seconds, as if you were reading a text.
                Keep your arms relaxed and avoid any movement, including your legs. 
                Use the movement bar as a reference to avoid excessive movement.
                Tap the button below twice when you are ready.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step2.png" alt="Step 2 Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep2" onclick="handleTap(this, '2')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 1 (Tap Twice)
            </button>
        </div>

        <div id="step2-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 1: On Hand</h2>
                <div id="timer2" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:12
                </div>
            </div>
            <div id="bar2" class="movement-bar"></div>
            <button id="confirmStep2" onclick="handleTap(this, '2')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 1 (Tap Twice)
            </button>
        </div>
        
        <!-- Step 3: On Table -->
        <div id="step3-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 2: On Table</h2>
                <div id="bar0" class="movement-bar"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:12</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Place your phone on a flat surface, such as a table or the floor, and leave it untouched for 10 seconds. 
                Make sure to place it before continuing, and do not pick it up until the full 10 seconds have passed.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step3.png" alt="Step 3 Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep3" onclick="handleTap(this, '3')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 2 (Tap Twice)
            </button>
        </div>

        <div id="step3-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 2: On Table</h2>
                <div id="timer3" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:12
                </div>
            </div>
            <div id="bar3" class="movement-bar"></div>
            <button id="confirmStep3" onclick="handleTap(this, '3')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 2 (Tap Twice)
            </button>
        </div>
        
        <!-- Step 4A: Repeat Step 2 (On Hand) -->
        <div id="step4A-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 3A: Repeat On Hand</h2>
                <div id="bar0" class="movement-bar"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:12</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Just like before, hold your phone still in your hand for 10 seconds. 
                This time, inaudible audio will play in the background. 
                Before you proceed, please confirm that <strong>your phone's volume is set to maximum</strong>. 
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step2.png" alt="Step 4A Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep4A" onclick="handleTap(this, '4A')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 3A (Tap Twice)
            </button>
        </div>

        <div id="step4A-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 3A: Repeat On Hand</h2>
                <div id="timer4A" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:12
                </div>
            </div>
            <div id="bar4A" class="movement-bar"></div>
            <button id="confirmStep4A" onclick="handleTap(this, '4A')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 3A (Tap Twice)
            </button>
        </div>

        <!-- Step 4B: Repeat Step 3 (On Table) -->
        <div id="step4B-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 3B: Repeat On Table</h2>
                <div id="bar0" class="movement-bar"></div>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:12</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Once again, place your phone on a flat surface and leave it untouched for 10 seconds.
                Inaudible audio will continue playing in the background.
                Please <strong>place your phone before continuing</strong>.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step3.png" alt="Step 4B Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep4B" onclick="handleTap(this, '4B')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 3B (Tap Twice)
            </button>
        </div>

        <div id="step4B-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 3B: Repeat On Table</h2>
                <div id="timer4B" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:12
                </div>
            </div>
            <div id="bar4B" class="movement-bar"></div>
            <button id="confirmStep4B" onclick="handleTap(this, '4B')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 3B (Tap Twice)
            </button>
        </div>

        <!-- Step 5A: First 10 Steps Walk -->
        <div id="step5A-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 4A: Walk First 10 Steps</h2>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:15</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                Find a location where you can walk 10 steps in a straight line. 
                Hold your phone naturally in your hand and take exactly 10 steps at a regular pace.
                Remember to <strong>extend your arms</strong> when walking. 
                If you experience any issues or disruptions, feel free to mention them when naming the recording at the end. 
                Once you're ready, tap the button twice.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step5.png" alt="Step 5A Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep5A" onclick="handleTap(this, '5A')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 4A (Tap Twice)
            </button>
        </div>

        <div id="step5A-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 4A: Walk First 10 Steps</h2>
                <div id="timer5A" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:15
                </div>
            </div>
            <button id="confirmStep5A" onclick="handleTap(this, '5A')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 4A (Tap Twice)
            </button>
        </div>

        <!-- Step 5B: Second 10 Steps Walk -->
        <div id="step5B-explanation" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden explanation-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 4B: Walk Second 10 Steps</h2>
                <div id="timer0" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">00:15</div>
            </div>
            <p class="text-sm sm:text-base mb-4 text-justify">
                After completing the first 10 steps, pause briefly, then change direction and walk another 10 steps in a straight line. 
                Please take exactly 10 steps. 
                After this, you will be done with this data collection session.
                Tap the button below twice to continue.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step5.png" alt="Step 5B Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <button id="startStep5B" onclick="handleTap(this, '5B')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Start Step 4B (Tap Twice)
            </button>
        </div>

        <div id="step5B-execution" class="bg-white shadow-md rounded p-4 sm:p-6 mb-8 w-full max-w-3xl relative hidden execution-card">
            <div class="flex justify-between items-center mb-2 sm:mb-4">
                <h2 class="text-lg sm:text-2xl font-bold">Step 4B: Walk Second 10 Steps</h2>
                <div id="timer5B" class="text-lg sm:text-2xl font-bold p-2 bg-white shadow-md rounded">
                    00:15
                </div>
            </div>
            <button id="confirmStep5B" onclick="handleTap(this, '5B')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full text-sm sm:text-base">
                Confirm Step 4B (Tap Twice)
            </button>
        </div>
    
        <div id="step6" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl hidden explanation-card">
            <h2 class="text-2xl font-bold mb-4 text-center">Finish Recording</h2>
            <p class="mb-4 text-justify">
                Congratulations! You have completed all steps. 
                Return to the Sensor Logger app and tap 'Stop Recording'. 
                You can <strong>name the recording</strong> however you like; if there is something worth noticing, please include it in the name.
            </p>
            <p class="mb-4 text-justify">
                If there is an error during data upload, you can send the recording directly to me. 
                <a href="javascript:void(0);" onclick="showPopup()">Click <u>here</u> for extra details</a>.
            </p>
            <div class="flex justify-center items-center">
                <div class="mt-3 mb-4">
                    <img src="media/step6.png" alt="Step 6 Instruction" class="w-full rounded uniform-image">
                </div>
            </div>
            <p class="mb-4 text-justify">
                We greatly appreciate your participation.
                We encourage you to go on and take another data collection session. 
                Your participation in 10 sessions is crucial.
            </p>
            <p class="mb-1 text-center text-lg flex items-center justify-center space-x-2">
                Completed sessions on this device: 
                <span id="sessionCount" class="ml-2 text-lg font-bold">0</span>
                <button onclick="updateSessionCount(1)" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded">+</button>
                <button onclick="updateSessionCount(-1)" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">-</button>
            </p>
            <button onclick="finishStudy()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-full">
                Confirm Recording Stopped and Uploaded 100%
            </button>
        </div>
        
        <div class="flex justify-center w-full max-w-3xl mb-1">
            <button id="resetButton" onclick="showModal()" class="bg-[#486585] hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" style="background-color: #e4313e;">
                Reset Data Collection Session
            </button>
        </div>

        <div id="importantNote" class="bg-white shadow-md rounded p-6 mb-8 w-full max-w-3xl" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-center">Important Note</h2>
            <p class="text-justify">
                Please do not delete your browser cookies for the duration of the study. This is crucial for the experiment to function properly and for us to differentiate your device from others.
            </p>
        </div>
    </main>

    <div id="confirmationModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
            <div class="bg-red-600 text-white text-lg font-bold p-4 text-center">
                Stop Data Recording!
            </div>
            <div class="p-6">
                <p class="text-center text-gray-700 mb-4">
                    Please stop the data recording in the Sensor Logger app before resetting the session.
                    This is crucial to prevent data loss.
                </p>
                <div class="flex justify-center space-x-4">
                    <button onclick="proceedReset()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        I Have Stopped Recording
                    </button>
                    <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Upload -->
    <div id="popupModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
            <div class="bg-blue-600 text-white text-lg font-bold p-4 text-center">
                How to Send Your Recording
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">
                    Follow these steps if there's an error during the data upload:
                </p>
                <ol class="list-decimal list-inside mb-4 text-gray-700">
                    <li>Open the "Recordings" section in the Sensor Logger app.</li>
                    <li>Select the recording you just completed.</li>
                    <li>Click on "Export" and send it to me via email or WhatsApp:</li>
                    <ul class="list-none pl-6">
                        <li><strong>Email:</strong> c.sulbaranfandino@campus.tu-berlin.de</li>
                        <li><strong>WhatsApp:</strong> +49 1747 888029</li>
                    </ul>
                </ol>
                <div class="flex justify-center mt-4">
                    <button onclick="closePopup()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-4">
        <div class="container mx-auto px-4 flex justify-center items-center space-x-4">
            <p>c.sulbaranfandino@campus.tu-berlin.de</p>
        </div>
    </footer>
    
    <script>
        // Check if the device is mobile
        var isMobile = /iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent);

        let tapCount = 0;
        let currentStep = 0;

        function handleReadyTap(button) {
            tapCount++;
            if (tapCount === 2) {
                document.querySelector('header').classList.add('hidden');
                showExplanation('1');
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 500);
        }

        function handleTap(button, step) {
            // Vibrate the device
            if ('vibrate' in navigator) {
                navigator.vibrate(100);
            }

            tapCount++;
            if (tapCount === 2) {
                if (currentStep === 0) {
                    showExplanation(step);
                } else if (currentStep === 1) {
                    showExecution(step);
                } else {
                    completeStep(step);
                }
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 500);
        }

        function showExplanation(step) {
            hideAllSteps();
            document.getElementById(`step${step}-explanation`).classList.remove('hidden');
            currentStep = 1;
            if (step === '4B' || step === '5A') {
                stopInaudibleSound();
            }
        }

        function showExecution(step) {
            hideAllSteps();
            document.getElementById(`step${step}-execution`).classList.remove('hidden');
            currentStep = 2;

            const durations = { '1': 15, '2': 12, '3': 12, '4A': 12, '4B': 12, '5A': 15, '5B': 15 };
            startTimer(durations[step], document.querySelector(`#timer${step}`));

            if (step === '4A' || step === '4B') {
                playInaudibleSound();
            }
        }

        function completeStep(step) {
            hideAllSteps();
            const nextStep = getNextStep(step);
            if (nextStep) {
                showExplanation(nextStep);
            } else if (step === '5B') {
                showStep6();
            }
        }

        function getNextStep(currentStep) {
            const stepSequence = ['1', '2', '3', '4A', '4B', '5A', '5B'];
            const currentIndex = stepSequence.indexOf(currentStep);
            if (currentIndex !== -1 && currentIndex < stepSequence.length - 1) {
                return stepSequence[currentIndex + 1];
            }
            return null;
        }

        function hideAllSteps() {
            document.querySelectorAll('[id^="step"]').forEach(stepDiv => {
                stepDiv.classList.add('hidden');
            });
        }

        function startTimer(duration, display) {
            let timer = duration, seconds;
            setTimeout(function() {
                let interval = setInterval(function () {
                    seconds = parseInt(timer % 60, 10);
                    seconds = seconds < 10 ? "0" + seconds : seconds;

                    display.textContent = "00:" + seconds;

                    if (--timer < 0) {
                        clearInterval(interval);
                        timer = 0;
                    }
                }, 1000);
            }, 1500); // Set a 1.5-second delay before starting the timer
        }

        function showStep6() {
            document.getElementById('step6').classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
        }

        function finishStudy() {
            alert("Thank you for participating in our study! You will now be redirected to the home page.");
            window.location.href = "index.html";  // Redirect to the home page
        }

        function showModal() {
            document.getElementById('confirmationModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }

        function proceedReset() {
            closeModal();
            resetSession();
        }

        function resetSession() {
            hideAllSteps();
            document.querySelector('header').classList.remove('hidden');
            document.getElementById('step0').classList.remove('hidden');
            currentStep = 0;
            tapCount = 0;
            stopInaudibleSound();
            window.location.href = window.location.href;
        }

        function showPopup() {
            document.getElementById('popupModal').classList.remove('hidden');
        }

        function closePopup() {
            document.getElementById('popupModal').classList.add('hidden');
        }

        let audioContext;
        let oscillator;

        function playInaudibleSound() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioContext.createOscillator();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(20000, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
        }

        function stopInaudibleSound() {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        const baseWidth = 10;

        function handleMotion(event) {
            const acceleration = event.acceleration;
            if (!acceleration.x && !acceleration.y && !acceleration.z) {
                return; // If no acceleration data, do nothing
            }

            const magnitude = Math.sqrt(
                acceleration.x ** 2 + 
                acceleration.y ** 2 + 
                acceleration.z ** 2
            );
            
            // Change width of the bar based on the magnitude
            const newWidth = baseWidth + magnitude * 150;
            const clampedWidth = Math.min(Math.max(newWidth, 10), 80);

            // Update each bar
            document.querySelectorAll('[id^="bar"]').forEach(bar => {
                bar.style.width = `${clampedWidth}px`;

                // Change the color of the bar based on the magnitude
                if (magnitude < 0.4) {
                    bar.style.backgroundColor = 'green';
                } else if (magnitude < 1) {
                    bar.style.backgroundColor = 'yellow';
                } else {
                    bar.style.backgroundColor = 'red';
                }
            });
        }

        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', handleMotion, true);
        }

        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function checkSessionCookie() {
            var sessions = getCookie("completedSessions");
            if (!sessions) {
                setCookie("completedSessions", 0, 365);
                sessions = 0;
            }
            return parseInt(sessions);
        }

        function updateSessionCount(increment) {
            var sessions = checkSessionCookie();
            sessions += increment;
            if (sessions < 0) sessions = 0;
            if (sessions > 10) sessions = 10;
            setCookie("completedSessions", sessions, 365);
            document.getElementById('sessionCount').textContent = sessions;
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('sessionCount').textContent = checkSessionCookie();
        });
    </script>
</body>
</html>
